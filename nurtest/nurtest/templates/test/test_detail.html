{% extends 'shablons/main.html' %}

{% block title %}{{ test.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="alert alert-danger text-center fw-bold fs-5" id="timer-container">
        –í—Ä–µ–º—è: <span id="timer">05:00</span>
    </div>
    
    <h2 class="text-center mb-4">{{ test.title }}</h2>
    <form method="POST" class="needs-validation" novalidate>
        {% csrf_token %}
        {% for question in page_obj %}
        <fieldset class="mb-4">
            <legend class="h5 d-flex align-items-center">
                <span id="question-text-{{ question.id }}">{{ question.text }}</span>
                <button type="button" class="btn btn-outline-primary btn-sm ms-2"
                    onclick="speakQuestion({{ question.id }})">
                    üîä
                </button>
            </legend>
            <div class="mt-3">
                {% if question.question_type == 'single' %}
                {% for answer in question.answerchoice_set.all %}
                <div class="form-check">
                    <input type="radio" class="form-check-input" id="question_{{ question.id }}_{{ answer.id }}"
                        name="{{ question.id }}" value="{{ answer.id }}" required>
                    <label class="form-check-label" for="question_{{ question.id }}_{{ answer.id }}">
                        {{ answer.text }}
                    </label>
                </div>
                {% endfor %}
                {% elif question.question_type == 'multiple' %}
                {% for answer in question.answerchoice_set.all %}
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="question_{{ question.id }}_{{ answer.id }}"
                        name="{{ question.id }}" value="{{ answer.id }}">
                    <label class="form-check-label" for="question_{{ question.id }}_{{ answer.id }}">
                        {{ answer.text }}
                    </label>
                </div>
                {% endfor %}
                {% elif question.question_type == 'text' %}
                <textarea class="form-control mt-2" name="{{ question.id }}" rows="3" required></textarea>
                {% endif %}
            </div>
        </fieldset>
        {% endfor %}

        <div class="text-center">
            <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-right"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
        </div>
    </form>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
        <ul class="pagination justify-content-center mt-4">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">–ü–µ—Ä–≤–∞—è</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- JavaScript –¥–ª—è –æ–∑–≤—É—á–∫–∏ -->
<script>
    function speakQuestion(questionId) {
        let text = document.getElementById("question-text-" + questionId).innerText;
        let speech = new SpeechSynthesisUtterance(text);
        speech.lang = "ru-RU";
        speech.volume = 1;
        speech.rate = 1;
        speech.pitch = 1;
        window.speechSynthesis.speak(speech);
    }

    // –¢–∞–π–º–µ—Ä
       document.addEventListener("DOMContentLoaded", function () {
            let totalTime = 5 * 60;  // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            let timerKey = "test_timer";  // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –≤ localStorage
            let savedTime = localStorage.getItem(timerKey);
            let timeLeft = savedTime ? parseInt(savedTime) : totalTime;
            let timerElement = document.getElementById("timer");

            function updateTimer() {
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                timerElement.innerText = `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;

                if (timeLeft <= 0) {
                    localStorage.removeItem(timerKey);
                    document.forms[0].submit();  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                } else {
                    timeLeft--;
                    localStorage.setItem(timerKey, timeLeft);
                    setTimeout(updateTimer, 1000);
                }
            }

            updateTimer();

            // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.addEventListener("beforeunload", function () {
                localStorage.removeItem(timerKey);
            });
        });
        
</script>

{% endblock %}