{% extends 'shablons/main.html' %}

{% block title %}{{ test.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">{{ test.title }}</h2>
    <form method="POST" class="needs-validation" novalidate>
        {% csrf_token %}
        {% for question in questions %}
        <fieldset class="mb-4">
            <legend class="h5 d-flex align-items-center">
                <span id="question-text-{{ question.id }}">{{ question.text }}</span>
                <button type="button" class="btn btn-outline-primary btn-sm ms-2"
                    onclick="speakQuestion({{ question.id }})">
                    üîä 
                </button>
            </legend>
            <div class="mt-3">
                {% if question.question_type == 'single' %}
                {% for answer in question.answerchoice_set.all %}
                <div class="form-check">
                    <input type="radio" class="form-check-input" id="question_{{ question.id }}_{{ answer.id }}"
                        name="{{ question.id }}" value="{{ answer.id }}" required>
                    <label class="form-check-label" for="question_{{ question.id }}_{{ answer.id }}">
                        {{ answer.text }}
                    </label>
                </div>
                {% endfor %}
                {% elif question.question_type == 'multiple' %}
                {% for answer in question.answerchoice_set.all %}
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="question_{{ question.id }}_{{ answer.id }}"
                        name="{{ question.id }}" value="{{ answer.id }}">
                    <label class="form-check-label" for="question_{{ question.id }}_{{ answer.id }}">
                        {{ answer.text }}
                    </label>
                </div>
                {% endfor %}
                {% elif question.question_type == 'text' %}
                <textarea class="form-control mt-2" name="{{ question.id }}" rows="3" required></textarea>
                {% endif %}
            </div>
        </fieldset>
        {% endfor %}
        <div class="text-center">
            <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-right"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
        </div>
    </form>
</div>

{% if score is not none %}
<div class="mt-4 text-center">
    <h3>–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
    <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã: {{ score }} / {{ questions|length }}</p>
    <p>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {{ percentage }}%</p>
</div>
{% endif %}

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript –¥–ª—è –æ–∑–≤—É—á–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ -->
<script>
    function speakQuestion(questionId) {
        let text = document.getElementById("question-text-" + questionId).innerText;
        let speech = new SpeechSynthesisUtterance(text);
        speech.lang = "ru-RU";  // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
        speech.volume = 1;       // –ì—Ä–æ–º–∫–æ—Å—Ç—å
        speech.rate = 1;         // –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏
        speech.pitch = 1;        // –¢–µ–º–±—Ä –≥–æ–ª–æ—Å–∞
        window.speechSynthesis.speak(speech);
    }
</script>

{% endblock %}